# Use an official Python runtime as a parent image
FROM python:3.10

# Install dependencies
RUN apt update && apt upgrade -y && \
    apt install -y wget unzip  && \
    rm -rf /var/lib/apt/lists/*

# Download and install htslib-1.9
RUN cd /usr/local/bin && \
    wget https://github.com/samtools/htslib/releases/download/1.9/htslib-1.9.tar.bz2 && \
    tar -vxjf htslib-1.9.tar.bz2 && \
    cd htslib-1.9 && \
    make
ENV PATH="/usr/local/bin/htslib-1.9/:$PATH" 

# Download and install BCFTools-1.9
RUN cd /usr/local/bin && \
    wget https://github.com/samtools/bcftools/releases/download/1.9/bcftools-1.9.tar.bz2 && \
    tar -vxjf bcftools-1.9.tar.bz2 && \
    cd bcftools-1.9 && \
    make
ENV PATH="/usr/local/bin/bcftools-1.9/:$PATH" 


# Download and install Plink 1.9
RUN wget https://s3.amazonaws.com/plink1-assets/plink_linux_x86_64_20201019.zip -O /tmp/plink.zip && \
    unzip /tmp/plink.zip -d /usr/local/bin/ && \
    rm /tmp/plink.zip && \
    chmod +x /usr/local/bin/plink

# Install Illumina CLI
COPY executables/array-analysis-cli-linux-x64-v2.1.0.tar.gz .
RUN gzip -d array-analysis-cli-linux-x64-v2.1.0.tar.gz && \
    tar -xvf array-analysis-cli-linux-x64-v2.1.0.tar && \
    mv array-analysis-cli-linux-x64-v2.1.0/array-analysis-cli /usr/local/bin/
ENV PATH="/usr/local/bin/array-analysis-cli/:$PATH" 

# Set the working directory
WORKDIR /workspace

# Copy any needed files
COPY poetry.lock pyproject.toml /workspace

# Install requirements
RUN pip install poetry && poetry export --without-hashes --format=requirements.txt > requirements.txt
RUN pip install -r requirements.txt

# Run a command by default
CMD ["python", "--version"]
